# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

crosvm is a Virtual Machine Monitor (VMM) based on Linux's KVM hypervisor, written in Rust. It focuses on simplicity, security, and speed, running Linux/Android guests on ChromeOS devices. Key characteristics:
- Process-per-device architecture with each device sandboxed via minijail
- Multi-platform: Linux, Android, Windows; x86_64, aarch64, riscv64
- Multiple hypervisor backends (KVM, WHPX/HAXM, Geniezone, Gunyah)
- Paravirtualized devices using virtio standard

## Build Commands

```bash
cargo build                      # Debug build
cargo build --release            # Release build
cargo test --workspace           # Run all unit tests
cargo test -p <crate_name>       # Test specific crate
cargo test <test_name>           # Run single test by name
./tools/presubmit --all          # Full presubmit validation
```

## Code Formatting and Linting

```bash
./tools/fmt                      # Format with stable rustfmt
./tools/fmt --nightly            # Format with unstable import rules
./tools/check                    # Run clippy and checks
```

Import style (enforced by `./tools/fmt --nightly`):
- One import per `use` statement (`imports_granularity = "item"`)
- Group order: std, external crates, crate/super

## Testing

Unit tests are in `#[cfg(test)]` modules within each crate. E2E tests in `e2e_tests/` run actual VMs:
```bash
./tools/run_tests --dut=vm -E 'rdeps(e2e_tests)'
```

Custom kernel/rootfs via environment variables: `CROSVM_CARGO_TEST_KERNEL_IMAGE`, `CROSVM_CARGO_TEST_ROOTFS_IMAGE`

## Architecture

### Process Model
Main process manages VCPUs and control loop. Each device forks into a jailed subprocess with restricted FD access, communicating via unix sockets and shared memory.

### Key Crates
- `src/` - Main binary, CLI parsing, VM configuration
- `base/` - Cross-platform system abstractions (FDs, events, memory mapping)
- `hypervisor/` - Hypervisor abstraction layer (KVM, WHPX, etc.)
- `devices/` - Virtual devices, especially `devices/src/virtio/` for virtio devices
- `arch/`, `x86_64/`, `aarch64/`, `riscv64/` - Architecture-specific code
- `vm_memory/` - GuestMemory, MemoryMapping, VolatileSlice
- `vm_control/` - IPC protocol for VM control
- `jail/` - Minijail wrappers; seccomp policies in `jail/seccomp/{arch}/`
- `cros_async/` - Async executor (io_uring/epoll backends)
- `disk/` - Disk image formats (raw, qcow2, sparse)

### Device Model Hierarchy
- `BusDevice` trait - MMIO/IO port access
- `PciDevice` trait - PCI configuration space (extends BusDevice)
- `VirtioDevice` trait - Transport-agnostic virtio interface
- `VirtioPciDevice` - Adapts VirtioDevice to PCI transport

### Key Patterns
- `VirtioDevice::activate()` spawns worker thread; never blocks VCPU
- `WaitContext` wraps epoll/WaitForMultipleObjects for event loops
- Platform code split via `#[cfg(...)]` into `sys/linux/` and `sys/windows/`
- Error enums use `#[sorted]` from the `remain` crate

## Code Style

- Prefer single-responsibility functions; split at ~6 parameters
- Minimize `unsafe` scope; use `#[deny(unsafe_op_in_unsafe_fn)]`
- Safety comments: `// SAFETY:` for blocks, `# Safety` doc section for functions
- Tests: Arrange-Act-Assert, one behavior per test, avoid helper methods that hide assertions

## Commit Messages

```
component: Short description (max 50 chars)

Body explaining motivation and impact (wrap to 72 chars).

BUG=b:12345678
TEST=tools/presubmit --all

Change-Id: <auto-generated>
```

Component tags are usually crate names (e.g., `devices:`, `base:`, `hypervisor:`).

## Contributing

Changes go through Gerrit, not GitHub PRs:
```bash
git checkout -b feature --track origin/main
# make changes
./tools/cl upload
```

Request review from crosvm-reviews@google.com. CQ runs tests before merge.

## macOS Development

### Running VMs on macOS

```bash
# Build and sign for Hypervisor.framework
cargo build --release
codesign --sign - --entitlements crosvm.entitlements --force target/release/crosvm

# Basic run with kernel
./target/release/crosvm run -m 512 arm64_Image

# Add kernel command line parameters with -p
./target/release/crosvm run -m 512 -p "keep_bootcon panic=5" arm64_Image

# Run with a disk image
./target/release/crosvm run -m 512 --disk rootfs.img arm64_Image

# Run with disk and custom kernel params
./target/release/crosvm run -m 512 --disk rootfs.img -p "root=/dev/vda rw" arm64_Image
```

Use `-p` to append kernel command line parameters instead of modifying code.
